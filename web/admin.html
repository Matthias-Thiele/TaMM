<!DOCTYPE html>
<!--
(c) 2023 by Matthias Thiele
GNU General Public License v3.0
-->
<html>
    <head>
        <title>System Administration</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" href="tamm.css">
        <link rel="shortcut icon" href="favicon.ico"/> 
        <style>
            .admin-sidebar {
                display:flex;
                flex-wrap:wrap;
            }

            /* columns */
            .admin-sidebar > * {
                width:100%;
                padding:1rem;
            }

            /* tablet breakpoint */
            @media (min-width:768px) {
                .admin-sidebar > *:nth-child(1) {
                    width:calc(88% / 3);
                    max-width: 180pt;
                    order:-1;
                    border-right: 1px solid silver
                }

                .admin-sidebar > *:nth-child(2) {
                    width:calc(88% / 3);
                    max-width: 180pt;
                    order:-1;
                    border-right: 1px solid silver
                }

                .admin-sidebar > *:nth-child(3) {
                    width:calc(88% / 3);
                    order:-1;
                    border-right: 1px solid silver
                }
            }
            
        </style>
        
        <script src="common.js"></script> 
        <script>
            var clientlist;
            var selectedClient = {};
            
            /**
             * Load user information and other session data.
             * @returns {undefined}
             */
            function loadAdminData() {
                initForm("save");
                status = document.getElementById("status");
                status.innerText = "Wait for server...";
                
                var request = new XMLHttpRequest();
                request.open("GET", "system/clientlist");
                request.setRequestHeader('Content-Type', 'application/json');
                request.send();
                request.overrideMimeType('application/json');
                request.onreadystatechange = function() {
                    if (this.readyState === 4 && this.status === 200) {
                        var response = JSON.parse(this.responseText);
                        if (response.result === "error") {
                            status.innerText = response.message;
                        } else {
                            clientlist = response.data;
                            createClientList(clientlist);
                        }
                    }
                };
            }

            function doSave() {
                var data = {};
                data.dburl = document.getElementById("dburl").value;
                data.name = document.getElementById("name").value;
                data.password = document.getElementById("password").value;
                console.log(data);
                
                var request = new XMLHttpRequest();
                request.open("POST", "system/initdata");
                request.setRequestHeader('Content-Type', 'application/json');
                request.send(JSON.stringify(data));
                request.overrideMimeType('text/json');
                request.onreadystatechange = function() {
                    if (this.readyState === 4 && this.status === 200) {
                        var response = JSON.parse(this.responseText);
                        if (response.result === "ok") {
                          createOptionList("clientnames", result.data);
                        } else {
                          var status = document.getElementById("status");
                          status.innerText = "Unbekannter Fehler beim Speichern.";
                        }
                    }
                };
            }
            
            function createClientList(clientlist) {
                var list = document.getElementById("clientlist");
                list.innerHTML = "";
                for(var clientName in clientlist) {
                    var clientInfo = clientlist[clientName];
                    var client = document.createElement("button");
                    var text = document.createTextNode(clientInfo.name)
                    client.appendChild(text);
                    client.key = clientInfo;
                    client.onclick = function() { fillClient(window.event.srcElement.key); };
                    client.style = "margin: 3pt;";
                    list.appendChild(client);
                };
            };
            
            function changed() {
                document.getElementById("saveclient").disabled = false;
            }
            
            function selectClient() {
                selectedClient = this.source.key;
            }
            
            function createClient() {
                selectedClient = {};
                selectedClient.id = -1;
                selectedClient.maxDocMB = 100;
                selectedClient.maxUser = 20;
                fillClient();
            }
            
            function fillClient(client) {
                if (client) {
                    selectedClient = client;
                }
                
                setValue("clientid", selectedClient.id);
                setValue("clientname", selectedClient.name);
                setValue("clienthost", selectedClient.hostName);
                setValue("clientmaxmb", selectedClient.maxDocMB);
                setValue("clientmaxuser", selectedClient.maxUser);
            }
            
            function saveClient() {
                selectedClient.name = getValue("clientname");
                selectedClient.hostName = getValue("clienthost");
                selectedClient.maxDocMB = getValue("clientmaxmb");
                selectedClient.maxUser = getValue("clientmaxuser");
                
                status = document.getElementById("status");
                status.innerText = "Wait for server...";
                
                var request = new XMLHttpRequest();
                request.open("POST", "system/saveclient");
                request.setRequestHeader('Content-Type', 'application/json');
                request.send(JSON.stringify(selectedClient));
                request.overrideMimeType('text/json');
                request.onreadystatechange = function() {
                    if (this.readyState === 4 && this.status === 200) {
                        var status = document.getElementById("status");
                        var response = JSON.parse(this.responseText);
                        if (response.result === "ok") {
                          status.innerText = "Mandant gespeichert."
                          emptyUser = {};
                          fillClient(emptyUser);
                          loadAdminData();
                        } else {
                            if (!response.message) {
                                response.message = "Unbekannter Fehler beim Speichern.";
                            }
                            status.innerText = response.message;
                        }
                    }
                };
            }
        </script>
    </head>
    <body onload="loadAdminData()">
        <div class="bodybox">
            <div class="header">System Administration</div>
            <div class="admin-sidebar">
                <div>
                    <div>Datenbankverbindung</div>
                    <div><label>Database URL</label><input type="text" id="dburl"></div>
                    <div><label>DB Admin Name</label><input type="text" id="name"></div>
                    <div><label>DB Password</label><input type="text" id="password"></div>
                    <div><button id="save" onclick="doSave();">Speichern</button></div>
                </div>
                <div>
                    <div>Mailserver</div>
                </div>
                <div>
                    <div>Mandanten<button style="margin-left: 10pt;" onclick="createClient();">Neu</button></div>
                    <div>
                        
                        <div id="clientlist"></div>
                        <hr>
                            <div><label for="clientid">Id</label><input type="text" id="clientid" readonly></div>
                            <div><label for="clientname">Mandantenname</label><input type="text" id="clientname"></div>
                            <div><label for="clienthost">Hostname</label><input type="text" id="clienthost"></div>
                            <div><label for="clientmaxmb">Id</label><input type="number" id="clientmaxmb"></div>
                            <div><label for="clientmaxuser">Id</label><input type="number" id="clientmaxuser"></div>
                            <button onclick="saveClient();">Mandant speichern</button>
                    </div>
                </div>
            </div>
            <div class="statusbar" id="statusbar">
                
                <span id="status"></span>
            </div>
        </div>
        <datalist id="clientnames"></datalist>
    </body>
</html>
